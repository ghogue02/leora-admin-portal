#!/bin/bash
# Session-End Hook: Generates comprehensive session summary
# Called when Claude Code session ends

# Note: Not using set -e to prevent hook failures from breaking the session

PROJECT_ROOT="/Users/greghogue/Leora2"
MEMORY_DIR="$PROJECT_ROOT/memory"
SESSION_FILE="$MEMORY_DIR/sessions/current_session.json"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

if [ ! -f "$SESSION_FILE" ]; then
  echo "${YELLOW}âš ï¸  No active session found${NC}"
  exit 0
fi

# Read session data
SESSION_ID=$(jq -r '.session_id' "$SESSION_FILE")
START_TIME=$(jq -r '.start_time' "$SESSION_FILE")
TASKS_COMPLETED=$(jq -r '.tasks_completed // 0' "$SESSION_FILE")
STEPS_COMPLETED=$(jq -r '.steps_completed // 0' "$SESSION_FILE")
TOOLS_USED=$(jq -r '.tools_used | length' "$SESSION_FILE")

# Calculate session duration
END_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)
START_EPOCH=$(date -j -f "%Y-%m-%dT%H:%M:%SZ" "$START_TIME" +%s 2>/dev/null || echo "0")
END_EPOCH=$(date +%s)
DURATION=$((END_EPOCH - START_EPOCH))
DURATION_MIN=$((DURATION / 60))

# Count new learning data from this session
NEW_TRAJECTORIES=$(find "$MEMORY_DIR/reasoningbank/trajectories" -type f -newermt "$START_TIME" 2>/dev/null | wc -l | tr -d ' ')
NEW_PATTERNS=$(find "$MEMORY_DIR/reasoningbank/patterns" -type f -newermt "$START_TIME" 2>/dev/null | wc -l | tr -d ' ')

# Update session file with end data
TMP_FILE=$(mktemp)
jq --arg end_time "$END_TIME" \
   --argjson duration "$DURATION" \
   --argjson new_trajectories "$NEW_TRAJECTORIES" \
   --argjson new_patterns "$NEW_PATTERNS" \
   '.end_time = $end_time | .duration_seconds = $duration | .new_trajectories = $new_trajectories | .new_patterns = $new_patterns | .status = "completed"' \
   "$SESSION_FILE" > "$TMP_FILE" && mv "$TMP_FILE" "$SESSION_FILE"

# Generate summary report
echo ""
echo "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo "${BOLD}${GREEN}ğŸ“Š SESSION SUMMARY & LEARNING REPORT${NC}"
echo "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo "${BOLD}Session Details:${NC}"
echo "  â€¢ Session ID: ${CYAN}$SESSION_ID${NC}"
echo "  â€¢ Duration: ${YELLOW}${DURATION_MIN} minutes${NC} (${DURATION}s)"
echo "  â€¢ Started: ${BLUE}$START_TIME${NC}"
echo "  â€¢ Ended: ${BLUE}$END_TIME${NC}"
echo ""
echo "${BOLD}Work Completed:${NC}"
echo "  â€¢ Tasks Completed: ${GREEN}$TASKS_COMPLETED${NC}"
echo "  â€¢ Steps Executed: ${GREEN}$STEPS_COMPLETED${NC}"
echo "  â€¢ Tools Used: ${GREEN}$TOOLS_USED${NC} different tools"
echo ""
echo "${BOLD}Learning Captured:${NC}"
echo "  â€¢ New Trajectories: ${BLUE}$NEW_TRAJECTORIES${NC}"
echo "  â€¢ New Patterns: ${GREEN}$NEW_PATTERNS${NC}"
echo "  â€¢ Session Data: ${CYAN}Saved to memory/sessions/${NC}"
echo ""
echo "${BOLD}Most Used Tools:${NC}"
jq -r '.tools_used | group_by(.tool) | map({tool: .[0].tool, count: length}) | sort_by(.count) | reverse | limit(5;.[]) | "  â€¢ \(.tool): \(.count)x"' "$SESSION_FILE" 2>/dev/null || echo "  â€¢ No tool data"
echo ""
echo "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo "${GREEN}âœ… All learning data saved for future sessions!${NC}"
echo "${BOLD}Next session will benefit from ${NEW_PATTERNS} new pattern(s) âš¡${NC}"
echo "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

exit 0
