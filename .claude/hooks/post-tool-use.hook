#!/bin/bash
# Post-Tool-Use Hook: Tracks progress during task execution
# Called after each tool use to provide mid-session updates

# Note: Not using set -e to prevent hook failures from breaking the session

# Get tool context
TOOL_NAME="${CLAUDE_TOOL_NAME:-unknown_tool}"
TOOL_STATUS="${CLAUDE_TOOL_STATUS:-success}"
STEP_NUM="${CLAUDE_STEP_NUMBER:-0}"
TOTAL_STEPS="${CLAUDE_TOTAL_STEPS:-0}"

PROJECT_ROOT="/Users/greghogue/Leora2"
MEMORY_DIR="$PROJECT_ROOT/memory"
SESSION_FILE="$MEMORY_DIR/sessions/current_session.json"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Create session tracking file if it doesn't exist
mkdir -p "$MEMORY_DIR/sessions"

if [ ! -f "$SESSION_FILE" ]; then
  cat > "$SESSION_FILE" <<EOF
{
  "session_id": "$(date +%s)",
  "start_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "tools_used": [],
  "steps_completed": 0,
  "current_task": ""
}
EOF
fi

# Increment step counter
STEPS_COMPLETED=$(jq -r '.steps_completed // 0' "$SESSION_FILE" 2>/dev/null || echo "0")
STEPS_COMPLETED=$((STEPS_COMPLETED + 1))

# Update session file
TMP_FILE=$(mktemp)
jq --arg tool "$TOOL_NAME" --arg status "$TOOL_STATUS" --argjson steps "$STEPS_COMPLETED" \
  '.tools_used += [{"tool": $tool, "status": $status, "timestamp": now | todate}] | .steps_completed = $steps' \
  "$SESSION_FILE" > "$TMP_FILE" && mv "$TMP_FILE" "$SESSION_FILE"

# Show progress every 5 steps or on errors
if [ $((STEPS_COMPLETED % 5)) -eq 0 ] || [ "$TOOL_STATUS" = "error" ]; then
  echo ""
  echo "${BLUE}ðŸ”„ Progress Update:${NC} Step ${YELLOW}$STEPS_COMPLETED${NC} | Last tool: ${GREEN}$TOOL_NAME${NC} ($TOOL_STATUS)"
fi

exit 0
